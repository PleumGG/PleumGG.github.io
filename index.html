<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hand Control 3D (FINAL)</title>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
}
video {
  position: fixed;
  right: 10px;
  bottom: 10px;
  width: 200px;
  transform: scaleX(-1);
  opacity: 0.4;
}
#status {
  position: fixed;
  left: 10px;
  top: 10px;
  color: white;
  font-family: sans-serif;
  background: rgba(0,0,0,0.6);
  padding: 6px 10px;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="status">ðŸŸ¢ CONTROL ON</div>
<video id="video" autoplay playsinline muted></video>

<script>
/* ========= THREE ========= */
const scene = new THREE.Scene()
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000)
camera.position.z = 4

const renderer = new THREE.WebGLRenderer({ antialias:true })
renderer.setSize(innerWidth, innerHeight)
document.body.appendChild(renderer.domElement)

const cube = new THREE.Mesh(
  new THREE.BoxGeometry(1,1,1),
  new THREE.MeshNormalMaterial()
)
scene.add(cube)

function animate(){
  requestAnimationFrame(animate)
  renderer.render(scene, camera)
}
animate()

/* ========= CAMERA ========= */
const video = document.getElementById("video")

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "user",
      width: { ideal: 640 },
      height: { ideal: 480 }
    },
    audio: false
  })

  video.srcObject = stream
  await new Promise(r => video.onloadedmetadata = r)
  await video.play()
}
startCamera()

/* ========= HAND ========= */
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
})

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
})

let lastX = null
let lastY = null

/* ===== TOGGLE STATE ===== */
let controlEnabled = true
let fistLocked = false
const statusEl = document.getElementById("status")

function updateStatus(){
  statusEl.textContent = controlEnabled ? "ðŸŸ¢ CONTROL ON" : "ðŸ”´ PAUSED"
}

/* ===== FIST DETECTION ===== */
function isFist(hand){
  const wrist = hand[0]
  const tips = [8,12,16,20] // à¸›à¸¥à¸²à¸¢à¸™à¸´à¹‰à¸§
  let folded = 0

  for (let i of tips) {
    const dx = hand[i].x - wrist.x
    const dy = hand[i].y - wrist.y
    const dist = Math.sqrt(dx*dx + dy*dy)
    if (dist < 0.12) folded++
  }
  return folded >= 3
}

/* ===== MAIN LOGIC ===== */
hands.onResults(res => {
  if (!res.multiHandLandmarks?.length) return

  const hand = res.multiHandLandmarks[0]

  /* ---- TOGGLE BY FIST ---- */
  const fist = isFist(hand)

  if (fist && !fistLocked) {
    controlEnabled = !controlEnabled
    updateStatus()
    fistLocked = true
  }

  if (!fist) {
    fistLocked = false
  }

  if (!controlEnabled) return

  /* ---- CONTROL ---- */
  const p = hand[9]
  const x = p.x
  const y = p.y

  if (lastX !== null) {
    cube.rotation.y += (x - lastX) * 6
    cube.rotation.x += (y - lastY) * 6
  }

  lastX = x
  lastY = y
})

/* ========= LOOP ========= */
async function detect(){
  if (video.readyState >= 2) {
    await hands.send({ image: video })
  }
  requestAnimationFrame(detect)
}
detect()

/* ========= RESIZE ========= */
addEventListener("resize", () => {
  camera.aspect = innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth, innerHeight)
})
</script>

</body>
</html>
