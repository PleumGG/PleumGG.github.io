/* --- ตัวแปรควบคุมใหม่ --- */
let currentGesture = "READY";
let gestureStartTime = 0;
let isExecuted = false; // เช็คว่าทำคำสั่งไปหรือยัง
const HOLD_TIME = 1000; // ตั้งไว้ 1 วินาที (1000ms)

hands.onResults(res => {
    let detectedCmd = "READY";

    if (res.multiHandLandmarks?.length) {
        res.multiHandLandmarks.forEach((lm, index) => {
            const label = res.multiHandedness[index].label; 
            const f = checkFingers(lm);

            // Logic ตรวจจับท่าทาง (เหมือนเดิม)
            if (label === "Left") {
                if (f.thumb && !f.index && !f.middle) detectedCmd = "ROTATE LEFT";
                else if (!f.thumb && f.index && !f.middle) detectedCmd = "ROTATE RIGHT";
                else if (f.index && f.middle && !f.ring) detectedCmd = "ROTATE UP";
                else if (f.index && f.middle && f.ring) detectedCmd = "ROTATE DOWN";
            } 
            else if (label === "Right") {
                if (f.thumb && !f.index) detectedCmd = "ZOOM IN";
                else if (!f.thumb && f.index) detectedCmd = "ZOOM OUT";
            }
        });
    }

    // --- LOGIC: HOLD TO CONFIRM ---
    if (detectedCmd !== "READY") {
        if (detectedCmd === currentGesture) {
            // ถ้ายังเป็นท่าเดิม ให้เช็คเวลา
            let elapsed = Date.now() - gestureStartTime;
            let progress = Math.min((elapsed / HOLD_TIME) * 100, 100);
            
            if (!isExecuted) {
                display.innerHTML = `${detectedCmd} <br> <small>HOLDING: ${Math.round(progress)}%</small>`;
                
                if (elapsed >= HOLD_TIME) {
                    executeCommand(detectedCmd);
                    isExecuted = true; // ล็อคไว้ว่าทำแล้ว ห้ามซ้ำ!
                }
            } else {
                display.innerHTML = `${detectedCmd} <br> <span style="color:#00ff00;">DONE (RELEASE TO RESET)</span>`;
            }
        } else {
            // ถ้าเปลี่ยนท่าใหม่ ให้เริ่มนับหนึ่งใหม่
            currentGesture = detectedCmd;
            gestureStartTime = Date.now();
            isExecuted = false;
        }
    } else {
        // ถ้าปล่อยมือ
        currentGesture = "READY";
        isExecuted = false;
        display.innerText = "READY";
    }
});

// แยกฟังก์ชันการทำงานออกมาให้จัดการง่าย
function executeCommand(cmd) {
    if (cmd === "ROTATE LEFT") tRotY -= Math.PI/2;
    if (cmd === "ROTATE RIGHT") tRotY += Math.PI/2;
    if (cmd === "ROTATE UP") tRotX -= Math.PI/2;
    if (cmd === "ROTATE DOWN") tRotX += Math.PI/2;
    if (cmd === "ZOOM IN") tZoom = Math.max(2, tZoom - 1.5);
    if (cmd === "ZOOM OUT") tZoom = Math.min(12, tZoom + 1.5);
    
    // Feedback สั้นๆ ว่าขยับแล้ว
    renderer.domElement.style.border = "2px solid #00ffcc";
    setTimeout(() => renderer.domElement.style.border = "none", 200);
}
