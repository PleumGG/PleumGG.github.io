<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surgical Control v2.2 - Fixed</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family: 'Courier New', monospace; }
        #ui {
            position: fixed; top: 20px; left: 20px; color: #00ffcc; z-index: 10;
            background: rgba(0,30,30,0.9); padding: 20px; border-left: 5px solid #00ffcc;
            min-width: 260px; pointer-events: none;
        }
        .command-text { font-size: 28px; font-weight: bold; color: white; margin-bottom: 5px; }
        
        /* Progress Bar - ทำให้เห็นชัดขึ้น */
        #progress-container {
            width: 100%; height: 12px; background: #111;
            border: 1px solid #333; margin: 10px 0; display: block;
        }
        #progress-bar {
            width: 0%; height: 100%; background: #00ffcc;
            box-shadow: 0 0 10px #00ffcc;
        }
        
        video {
            position: fixed; right: 10px; bottom: 10px; width: 180px; 
            transform: scaleX(-1); border-radius: 8px; border: 2px solid #00ffcc;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

    <div id="ui">
        <div style="font-size:12px; color:#00ccaa;">SYSTEM ACTIVE</div>
        <div id="gesture-display" class="command-text">SCANNING...</div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="status-msg" style="font-size:11px; color:#888;">READY FOR INPUT</div>
    </div>

    <video id="video" autoplay muted playsinline></video>

    <script>
        /* --- 1. THREE.JS SCENE SETUP --- */
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const cube = new THREE.Mesh(
            new THREE.BoxGeometry(2, 2, 2),
            [0xff4444, 0x44ff44, 0x4444ff, 0xffff44, 0xff44ff, 0x44ffff].map(c => new THREE.MeshStandardMaterial({color: c}))
        );
        scene.add(cube, new THREE.AmbientLight(0xffffff, 0.5), (() => {
            const l = new THREE.PointLight(0xffffff, 1.5); l.position.set(5,5,5); return l;
        })());
        camera.position.z = 6;

        let tRotX = 0, tRotY = 0, tZoom = 6;
        function animate() {
            requestAnimationFrame(animate);
            cube.rotation.x += (tRotX - cube.rotation.x) * 0.1;
            cube.rotation.y += (tRotY - cube.rotation.y) * 0.1;
            camera.position.z += (tZoom - camera.position.z) * 0.1;
            renderer.render(scene, camera);
        }
        animate();

        /* --- 2. GESTURE LOGIC --- */
        const display = document.getElementById("gesture-display");
        const progBar = document.getElementById("progress-bar");
        const statusMsg = document.getElementById("status-msg");

        let currentGesture = "READY";
        let gestureStartTime = 0;
        let isExecuted = false; 
        const HOLD_TIME = 1000; 

        // ฟังก์ชันเช็คนิ้วใหม่ (ลด Noise)
        function checkFingers(lm) {
            const getDist = (a, b) => Math.sqrt((lm[a].x-lm[b].x)**2 + (lm[a].y-lm[b].y)**2);
            const baseDist = getDist(0, 5); // ระยะฝ่ามืออ้างอิง
            return {
                thumb: getDist(4, 17) > baseDist * 0.8, // นิ้วโป้งกางออก
                index: lm[8].y < lm[6].y,              // นิ้วชี้ชูขึ้น
                middle: lm[12].y < lm[10].y,           // นิ้วกลางชูขึ้น
                ring: lm[16].y < lm[14].y              // นิ้วนางชูขึ้น
            };
        }

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        hands.onResults(res => {
            let detectedCmd = "READY";

            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                for (let i = 0; i < res.multiHandLandmarks.length; i++) {
                    const lm = res.multiHandLandmarks[i];
                    const label = res.multiHandedness[i].label;
                    const f = checkFingers(lm);

                    if (label === "Left") { // คุมการหมุน
                        if (f.thumb && !f.index && !f.middle) detectedCmd = "ROTATE LEFT";
                        else if (!f.thumb && f.index && !f.middle) detectedCmd = "ROTATE RIGHT";
                        else if (f.index && f.middle && !f.ring) detectedCmd = "ROTATE UP";
                        else if (f.index && f.middle && f.ring) detectedCmd = "ROTATE DOWN";
                    } 
                    else if (label === "Right") { // คุมซูม
                        if (f.thumb && !f.index) detectedCmd = "ZOOM IN";
                        else if (!f.thumb && f.index) detectedCmd = "ZOOM OUT";
                    }
                }
            }

            // --- HOLDING SYSTEM ---
            if (detectedCmd !== "READY") {
                if (detectedCmd === currentGesture) {
                    if (!isExecuted) {
                        let elapsed = Date.now() - gestureStartTime;
                        let percent = Math.min((elapsed / HOLD_TIME) * 100, 100);
                        
                        progBar.style.width = percent + "%";
                        display.innerText = detectedCmd;
                        statusMsg.innerText = `CHARGING... ${Math.round(percent)}%`;

                        if (elapsed >= HOLD_TIME) {
                            executeCommand(detectedCmd);
                            isExecuted = true;
                        }
                    } else {
                        progBar.style.width = "100%";
                        statusMsg.innerText = "ACTION COMPLETED (RELEASE HAND)";
                        display.innerHTML = `<span style="color:#00ffcc;">DONE: ${detectedCmd}</span>`;
                    }
                } else {
                    // เปลี่ยนท่าทาง: Reset ตัวนับใหม่
                    currentGesture = detectedCmd;
                    gestureStartTime = Date.now();
                    isExecuted = false;
                }
            } else {
                // ปล่อยมือ: Reset ทุกอย่าง
                currentGesture = "READY";
                gestureStartTime = 0;
                isExecuted = false;
                progBar.style.width = "0%";
                display.innerText = "READY";
                statusMsg.innerText = "WAITING FOR GESTURE";
            }
        });

        function executeCommand(cmd) {
            if (cmd === "ROTATE LEFT") tRotY -= Math.PI/2;
            if (cmd === "ROTATE RIGHT") tRotY += Math.PI/2;
            if (cmd === "ROTATE UP") tRotX -= Math.PI/2;
            if (cmd === "ROTATE DOWN") tRotX += Math.PI/2;
            if (cmd === "ZOOM IN") tZoom = Math.max(2, tZoom - 2);
            if (cmd === "ZOOM OUT") tZoom = Math.min(12, tZoom + 2);
            
            // Flash Effect
            document.body.style.background = "#004444";
            setTimeout(() => { document.body.style.background = "#000"; }, 150);
        }

        const cam = new Camera(document.getElementById("video"), {
            onFrame: async () => { await hands.send({image: document.getElementById("video")}); },
            width: 480, height: 360, facingMode: "user"
        });
        cam.start();
    </script>
</body>
</html>
