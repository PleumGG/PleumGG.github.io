<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surgical Debugger v4</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family: 'Courier New', monospace; }
        
        /* Debug Panel สำหรับเช็คบัค */
        #debug-panel {
            position: fixed; top: 10px; left: 10px; 
            background: rgba(0, 0, 0, 0.85); color: #00ff00;
            padding: 10px; border: 1px solid #00ff00; font-size: 12px; z-index: 100;
            line-height: 1.4; pointer-events: none;
        }

        #ui {
            position: fixed; top: 10px; right: 10px; 
            background: rgba(0,40,40,0.9); color: #00ffcc;
            padding: 15px; border-radius: 8px; border: 1px solid #00ffcc;
            min-width: 200px; text-align: center;
        }
        #gesture-name { font-size: 24px; font-weight: bold; color: white; }
        #loading-bar { width: 0%; height: 8px; background: #00ffcc; margin-top: 10px; transition: width 0.1s; }
        
        video {
            position: fixed; left: 10px; bottom: 10px; width: 160px; 
            transform: scaleX(-1); border: 1px solid #333;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

    <div id="debug-panel">
        <div>AI STATUS: <span id="ai-detecting">OFF</span></div>
        <div>HAND SEEN: <span id="hand-label">-</span></div>
        <div>FINGERS: <span id="finger-stat">-</span></div>
        <hr style="border:0; border-top:1px solid #00ff00">
        <div id="raw-coords">Waiting for data...</div>
    </div>

    <div id="ui">
        <div id="gesture-name">READY</div>
        <div id="loading-bar"></div>
    </div>

    <video id="video" autoplay muted playsinline></video>

    <script>
        /* --- THREE.JS --- */
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const cube = new THREE.Mesh(
            new THREE.BoxGeometry(2, 2, 2),
            [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff].map(c => new THREE.MeshStandardMaterial({color: c}))
        );
        scene.add(cube, new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 5, 5);
        scene.add(light);
        camera.position.z = 6;

        let tRotX = 0, tRotY = 0, tZoom = 6;
        function animate() {
            requestAnimationFrame(animate);
            cube.rotation.x += (tRotX - cube.rotation.x) * 0.1;
            cube.rotation.y += (tRotY - cube.rotation.y) * 0.1;
            camera.position.z += (tZoom - camera.position.z) * 0.1;
            renderer.render(scene, camera);
        }
        animate();

        /* --- DEBUGGER & GESTURE LOGIC --- */
        let activeGesture = "READY";
        let startTime = 0;
        let isDone = false;

        function updateDebug(label, fingers, raw) {
            document.getElementById("ai-detecting").innerText = "ON";
            document.getElementById("ai-detecting").style.color = "#00ff00";
            document.getElementById("hand-label").innerText = label;
            document.getElementById("finger-stat").innerText = 
                (fingers.thumb?'T ':'') + (fingers.index?'I ':'') + (fingers.middle?'M ':'') + (fingers.ring?'R':'');
            document.getElementById("raw-coords").innerText = raw;
        }

        function getGesture(lm, label) {
            // เช็คการยกนิ้ว (ปรับให้ง่ายขึ้น: ปลายนิ้วสูงกว่าข้อต่อกลางนิ้ว)
            const f = {
                thumb: label === "Left" ? lm[4].x < lm[2].x - 0.02 : lm[4].x > lm[2].x + 0.02,
                index: lm[8].y < lm[6].y,
                middle: lm[12].y < lm[10].y,
                ring: lm[16].y < lm[14].y
            };

            const rawInfo = `T_x:${lm[4].x.toFixed(2)} I_y:${lm[8].y.toFixed(2)}`;
            updateDebug(label, f, rawInfo);

            if (label === "Left") {
                if (f.thumb && !f.index && !f.middle) return "ROTATE_LEFT";
                if (f.index && !f.thumb && !f.middle) return "ROTATE_RIGHT";
                if (f.index && f.middle && !f.ring) return "ROTATE_UP";
                if (f.index && f.middle && f.ring) return "ROTATE_DOWN";
            } else if (label === "Right") {
                if (f.thumb && !f.index) return "ZOOM_IN";
                if (f.index && !f.thumb) return "ZOOM_OUT";
            }
            return "READY";
        }

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        hands.onResults(res => {
            let nowDetected = "READY";

            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                res.multiHandLandmarks.forEach((lm, i) => {
                    const label = res.multiHandedness[i].label; // "Left" หรือ "Right"
                    const g = getGesture(lm, label);
                    if (g !== "READY") nowDetected = g;
                });
            } else {
                document.getElementById("ai-detecting").innerText = "SEARCHING...";
                document.getElementById("ai-detecting").style.color = "red";
            }

            if (nowDetected !== activeGesture) {
                activeGesture = nowDetected;
                startTime = Date.now();
                isDone = false;
                document.getElementById("loading-bar").style.width = "0%";
            }

            if (activeGesture !== "READY" && !isDone) {
                const elapsed = Date.now() - startTime;
                const progress = Math.min((elapsed / 700) * 100, 100);
                document.getElementById("loading-bar").style.width = progress + "%";
                document.getElementById("gesture-name").innerText = activeGesture;

                if (elapsed >= 700) {
                    if (activeGesture === "ROTATE_LEFT") tRotY -= Math.PI/2;
                    if (activeGesture === "ROTATE_RIGHT") tRotY += Math.PI/2;
                    if (activeGesture === "ROTATE_UP") tRotX -= Math.PI/2;
                    if (activeGesture === "ROTATE_DOWN") tRotX += Math.PI/2;
                    if (activeGesture === "ZOOM_IN") tZoom = Math.max(2, tZoom - 2);
                    if (activeGesture === "ZOOM_OUT") tZoom = Math.min(12, tZoom + 2);
                    isDone = true;
                    document.getElementById("gesture-name").innerText = "DONE!";
                }
            } else if (isDone) {
                document.getElementById("gesture-name").innerText = "LOCKED";
            } else {
                document.getElementById("gesture-name").innerText = "READY";
                document.getElementById("loading-bar").style.width = "0%";
            }
        });

        new Camera(document.getElementById("video"), {
            onFrame: async () => { await hands.send({image: document.getElementById("video")}); },
            width: 640, height: 480
        }).start();
    </script>
</body>
</html>
