<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Surgical Control v5.0 - Safety Lock</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family: 'Courier New', monospace; touch-action: none; }
        
        #ui {
            position: fixed; top: 15px; left: 15px; color: #00ffcc; z-index: 1000;
            background: rgba(0,20,20,0.9); padding: 20px; border-left: 5px solid #ff4444; /* เริ่มต้นเป็นสีแดง */
            min-width: 250px; pointer-events: none; border-radius: 0 8px 8px 0;
            transition: border-color 0.3s;
        }
        #ui.unlocked { border-left-color: #00ffcc; } /* เปลี่ยนเป็นเขียวเมื่อปลดล็อค */

        .status-label { font-size: 10px; color: #aaa; letter-spacing: 2px; }
        #lock-status { font-weight: bold; color: #ff4444; }
        #ui.unlocked #lock-status { color: #00ffcc; }

        .command-text { font-size: 24px; font-weight: bold; color: white; margin-top: 5px; }
        #progress-container { width: 100%; height: 10px; background: #111; margin: 10px 0; }
        #progress-bar { width: 0%; height: 100%; background: #ff4444; transition: width 0.05s linear; }
        #ui.unlocked #progress-bar { background: #00ffcc; }

        #camera-monitor {
            position: fixed; right: 20px; bottom: 20px; width: 140px; height: 140px;
            z-index: 9999; border: 2px solid #555; border-radius: 20px;
            overflow: hidden; background: #000; transition: border-color 0.3s;
        }
        #ui.unlocked + #camera-monitor { border-color: #00ffcc; }

        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    </style>
</head>
<body>

    <div id="ui" id="main-ui">
        <div class="status-label">SYSTEM STATUS: <span id="lock-status">LOCKED</span></div>
        <div id="gesture-display" class="command-text">FIST TO UNLOCK</div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div style="font-size: 11px; color: #666;" id="hint-text">กำมือขวาค้างไว้เพื่อเข้าสู่โหมดควบคุม</div>
    </div>

    <div id="camera-monitor">
        <video id="video" autoplay muted playsinline></video>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const videoElement = document.getElementById('video');
        const uiElement = document.getElementById('ui');
        const lockStatusText = document.getElementById('lock-status');
        const gestureDisplayText = document.getElementById('gesture-display');
        const progBar = document.getElementById('progress-bar');
        const hintText = document.getElementById('hint-text');

        let isSystemUnlocked = false; // สถานะความปลอดภัย

        /* --- 1. THREE.JS --- */
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const cube = new THREE.Mesh(
            new THREE.BoxGeometry(2.5, 2.5, 2.5),
            [0xff4444, 0x44ff44, 0x4444ff, 0xffff44, 0xff44ff, 0x44ffff].map(c => new THREE.MeshStandardMaterial({color: c}))
        );
        scene.add(cube);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        camera.position.z = 8;

        let targetZoom = 8;
        let targetQuaternion = new THREE.Quaternion();

        function animate() {
            requestAnimationFrame(animate);
            cube.quaternion.slerp(targetQuaternion, 0.15);
            camera.position.z += (targetZoom - camera.position.z) * 0.1;
            renderer.render(scene, camera);
            if (videoElement.paused) videoElement.play();
        }
        animate();

        /* --- 2. GESTURE & SAFETY LOGIC --- */
        function checkFingers(lm) {
            const d = (pt) => Math.sqrt(Math.pow(lm[pt].x - lm[0].x, 2) + Math.pow(lm[pt].y - lm[0].y, 2));
            const f = {
                index: d(8) > d(6) * 1.15,
                middle: d(12) > d(10) * 1.15,
                ring: d(16) > d(14) * 1.15,
                pinky: d(20) > d(18) * 1.15
            };
            const isFisted = !f.index && !f.middle && !f.ring && !f.pinky; // กำมือจริงคือพับทุกนิ้ว
            return { ...f, isFisted };
        }

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

        let activeGesture = "READY";
        let startTime = null;
        let isActionExecuted = false;

        hands.onResults(res => {
            let detected = "READY";
            
            if (res.multiHandLandmarks?.length > 0) {
                const lm = res.multiHandLandmarks[0];
                const label = res.multiHandedness[0].label; // Left/Right จากมุมกล้อง
                const f = checkFingers(lm);

                if (!isSystemUnlocked) {
                    // โหมด LOCKED: รอท่ากำมือขวา (หันหน้ามือเข้ากล้อง)
                    if (label === "Right" && f.isFisted) {
                        detected = "UNLOCKING...";
                    }
                } else {
                    // โหมด UNLOCKED: รับคำสั่งจริง
                    const isControlFist = !f.middle && !f.ring;
                    if (label === "Left") {
                        if (f.pinky && isControlFist && !f.index) detected = "ROTATE LEFT";
                        else if (f.index && isControlFist && !f.pinky) detected = "ROTATE RIGHT";
                        else if (f.index && f.middle && !f.ring && !f.pinky) detected = "ROTATE UP";
                        else if (f.index && f.middle && f.ring && !f.pinky) detected = "ROTATE DOWN";
                    } else {
                        if (f.pinky && isControlFist && !f.index) detected = "ZOOM IN";
                        else if (f.index && isControlFist && !f.pinky) detected = "ZOOM OUT";
                    }
                }
            }

            // Logic การนับเวลาถอยหลัง (1 วินาที)
            if (detected !== "READY") {
                if (detected === activeGesture) {
                    if (!isActionExecuted) {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min((elapsed / 1000) * 100, 100);
                        progBar.style.width = progress + "%";
                        gestureDisplayText.innerText = detected;

                        if (elapsed >= 1000) {
                            if (!isSystemUnlocked && detected === "UNLOCKING...") {
                                unlockSystem();
                            } else if (isSystemUnlocked) {
                                runCommand(detected);
                                lockSystem(); // ทำเสร็จแล้วล็อคทันทีเพื่อความปลอดภัย
                            }
                            isActionExecuted = true;
                        }
                    }
                } else {
                    activeGesture = detected; startTime = Date.now(); isActionExecuted = false;
                    progBar.style.width = "0%";
                }
            } else {
                activeGesture = "READY"; startTime = null; isActionExecuted = false;
                progBar.style.width = "0%";
                gestureDisplayText.innerText = isSystemUnlocked ? "SYSTEM READY" : "FIST TO UNLOCK";
            }
        });

        function unlockSystem() {
            isSystemUnlocked = true;
            uiElement.classList.add('unlocked');
            lockStatusText.innerText = "UNLOCKED";
            hintText.innerText = "พร้อมรับคำสั่งผ่าตัด (ระบบจะล็อคอัตโนมัติหลังสั่งการ)";
            // Flash เขียว
            renderer.domElement.style.boxShadow = "inset 0 0 100px rgba(0,255,204,0.3)";
            setTimeout(() => renderer.domElement.style.boxShadow = "none", 500);
        }

        function lockSystem() {
            isSystemUnlocked = false;
            uiElement.classList.remove('unlocked');
            lockStatusText.innerText = "LOCKED";
            hintText.innerText = "กำมือขวาค้างไว้เพื่อเข้าสู่โหมดควบคุม";
            progBar.style.width = "0%";
        }

        function runCommand(cmd) {
            const angle = Math.PI / 2;
            const q = new THREE.Quaternion();
            if (cmd === "ROTATE LEFT") q.setFromAxisAngle(new THREE.Vector3(0, 1, 0), -angle);
            if (cmd === "ROTATE RIGHT") q.setFromAxisAngle(new THREE.Vector3(0, 1, 0), angle);
            if (cmd === "ROTATE UP") q.setFromAxisAngle(new THREE.Vector3(1, 0, 0), -angle);
            if (cmd === "ROTATE DOWN") q.setFromAxisAngle(new THREE.Vector3(1, 0, 0), angle);
            targetQuaternion.multiplyQuaternions(q, targetQuaternion);
            if (cmd === "ZOOM IN") targetZoom = Math.max(2, targetZoom - 2);
            if (cmd === "ZOOM OUT") targetZoom = Math.min(12, targetZoom + 2);
            
            // Effect แจ้งเตือนการทำงาน
            renderer.domElement.style.filter = "brightness(2)";
            setTimeout(() => renderer.domElement.style.filter = "brightness(1)", 150);
        }

        const cam = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cam.start();
    </script>
</body>
</html>
